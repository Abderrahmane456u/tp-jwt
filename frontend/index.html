<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TP JWT — Frontend</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    input { padding: 6px; margin: 6px 0; }
    button { margin: 6px; padding: 8px 12px; }
    pre { background: #f4f4f4; padding: 12px; border-radius: 6px; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .danger { color: #c33; }
  </style>
</head>
<body>
  <h1>TP — Authentification JWT</h1>

  <div class="box">
    <h3>Login</h3>
    <label>Username</label><br>
    <input id="username" value="admin"><br>
    <label>Password</label><br>
    <input id="password" type="password" value="1234"><br>
    <button id="btnLogin">Se connecter</button>
    <button id="btnLogout">Se déconnecter</button>
    <div id="loginMessage"></div>
  </div>

  <div class="box">
    <h3>Actions</h3>
    <button id="btnProfile">GET /profile</button>
    <button id="btnMe">GET /me</button>
    <button id="btnAdmin">GET /admin</button>
    <button id="btnRefresh">POST /refresh (obtenir nouveau access token)</button>
  </div>

  <div class="box">
    <h3>Tokens (localStorage)</h3>
    <div><strong>Access token:</strong></div>
    <pre id="accessToken">-</pre>
    <div><strong>Refresh token:</strong></div>
    <pre id="refreshToken">-</pre>
  </div>

  <div class="box">
    <h3>Réponse API</h3>
    <pre id="output">—</pre>
  </div>

<script>
const API = "http://127.0.0.1:5000";

function saveTokens(access, refresh) {
  if (access) localStorage.setItem("access_token", access);
  if (refresh) localStorage.setItem("refresh_token", refresh);
  renderTokens();
}

function clearTokens() {
  localStorage.removeItem("access_token");
  localStorage.removeItem("refresh_token");
  renderTokens();
}

function getAccess() { return localStorage.getItem("access_token"); }
function getRefresh() { return localStorage.getItem("refresh_token"); }

function renderTokens() {
  document.getElementById("accessToken").textContent = getAccess() || "-";
  document.getElementById("refreshToken").textContent = getRefresh() || "-";
}

function log(o) {
  if (o === undefined) o = "undefined";
  try { document.getElementById("output").textContent = JSON.stringify(o, null, 2); }
  catch(e) { document.getElementById("output").textContent = String(o); }
}

// handle 401 globally for fetch responses
async function handleResponse(resp) {
  if (resp.status === 401) {
    // clear tokens and show message
    clearTokens();
    const text = await resp.text();
    try {
      const json = JSON.parse(text);
      log({ error: "401 Unauthorized", message: json.error || text });
    } catch(e) {
      log({ error: "401 Unauthorized", message: text });
    }
    return null;
  }
  if (resp.status === 403) {
    const data = await resp.json().catch(()=>null);
    log({ error: "403 Forbidden", data });
    return null;
  }
  // try to parse json
  return resp.json().catch(async ()=> {
    return { status: resp.status, text: await resp.text() };
  });
}

document.getElementById("btnLogin").addEventListener("click", async () => {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const resp = await fetch(API + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, password })
  });
  const data = await handleResponse(resp) || await resp.json().catch(()=>null);
  if (data && data.access_token) {
    saveTokens(data.access_token, data.refresh_token);
    document.getElementById("loginMessage").innerHTML = "Connecté en tant que <strong>" + (data.user||username) + "</strong> (role: " + (data.role||"-") + ")";
    log(data);
  } else {
    // login failed: handleResponse already called clearTokens if 401
    if (data && data.error) {
      document.getElementById("loginMessage").innerHTML = "<span class='danger'>" + data.error + "</span>";
    } else {
      document.getElementById("loginMessage").innerHTML = "<span class='danger'>Erreur login</span>";
    }
    clearTokens();
  }
});

document.getElementById("btnLogout").addEventListener("click", () => {
  clearTokens();
  document.getElementById("loginMessage").innerText = "Déconnecté.";
  log({ status: "logged out" });
});

document.getElementById("btnProfile").addEventListener("click", async () => {
  const token = getAccess();
  const resp = await fetch(API + "/profile", {
    headers: { Authorization: "Bearer " + (token || "") }
  });
  const data = await handleResponse(resp);
  if (data) log(data);
});

document.getElementById("btnMe").addEventListener("click", async () => {
  const token = getAccess();
  const resp = await fetch(API + "/me", {
    headers: { Authorization: "Bearer " + (token || "") }
  });
  const data = await handleResponse(resp);
  if (data) log(data);
});

document.getElementById("btnAdmin").addEventListener("click", async () => {
  const token = getAccess();
  const resp = await fetch(API + "/admin", {
    headers: { Authorization: "Bearer " + (token || "") }
  });
  const data = await handleResponse(resp);
  if (data) log(data);
});

document.getElementById("btnRefresh").addEventListener("click", async () => {
  const refresh_token = getRefresh();
  if (!refresh_token) {
    log({ error: "Pas de refresh_token stocké" });
    return;
  }
  const resp = await fetch(API + "/refresh", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ refresh_token })
  });
  const data = await handleResponse(resp);
  if (data && data.access_token) {
    saveTokens(data.access_token, null); // remplace l'access token, conserve refresh
    log({ message: "Nouveau access token reçu" });
  }
});

// init
renderTokens();
log({ ready: true, note: "Use login then test profile/me/admin/refresh" });
</script>
</body>
</html>
