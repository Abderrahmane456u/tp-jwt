<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>JWT Frontend</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 20px auto; }
    button { padding: 10px; margin: 5px; }
    input { padding: 6px; margin: 4px; width: 200px; }
    pre { background: #f0f0f0; padding: 12px; border-radius: 6px; }
    .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
  </style>
</head>
<body>

<h1>TP JWT — Frontend</h1>

<div class="box">
  <h3>Login</h3>
  <input id="username" placeholder="username" value="admin"><br>
  <input id="password" type="password" placeholder="password" value="1234"><br>
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="box">
  <h3>Actions</h3>
  <button onclick="callAPI('/public-info')">/public-info (public)</button>
  <button onclick="callAPI('/profile', true)">/profile</button>
  <button onclick="callAPI('/me', true)">/me</button>
  <button onclick="callAPI('/admin', true)">/admin</button>
  <button onclick="callAPI('/can-write', true)">/can-write</button>
  <button onclick="refreshToken()">Refresh Token</button>
</div>

<div class="box">
  <h3>Tokens</h3>
  <pre id="tokens">-</pre>
</div>

<div class="box">
  <h3>Réponse API</h3>
  <pre id="output">-</pre>
</div>

<script>
const API = "http://127.0.0.1:5000";

function saveTokens(a, r) {
  if (a) localStorage.setItem("access", a);
  if (r) localStorage.setItem("refresh", r);
  displayTokens();
}

function displayTokens() {
  document.getElementById("tokens").textContent =
    JSON.stringify({
      access: localStorage.getItem("access"),
      refresh: localStorage.getItem("refresh")
    }, null, 2);
}

function logout() {
  localStorage.removeItem("access");
  localStorage.removeItem("refresh");
  displayTokens();
}

async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch(API + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username, password})
  });

  const data = await res.json();
  saveTokens(data.access_token, data.refresh_token);
  document.getElementById("output").textContent = JSON.stringify(data, null, 2);
}

async function callAPI(route, auth=false) {
  const headers = {};

  if (auth) headers.Authorization = "Bearer " + localStorage.getItem("access");

  const res = await fetch(API + route, {headers});
  
  document.getElementById("output").textContent =
    JSON.stringify(await res.json(), null, 2);
}

async function refreshToken() {
  const token = localStorage.getItem("refresh");

  const res = await fetch(API + "/refresh", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({refresh_token: token})
  });

  const data = await res.json();
  saveTokens(data.access_token, null);
  document.getElementById("output").textContent = JSON.stringify(data, null, 2);
}

displayTokens();
</script>
</body>
</html>
